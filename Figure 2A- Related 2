####Differential gene expression analysis generating YAP1 Immortal Gene Signature
####Yap-Myc vs Ctrl-Myc 21p analysis

library(DESeq2)
#Make a variable pointing to path your htseq count files are in
directory <- "~/Desktop/RNAseq_Analyses/2020_2021_Analyses_Old_Computer/DESeq2_Analyses_DataGenerated/Yap4_184A1_Ensembl_Count_Files/"

#Generate a sample table
#Get the names of all files want to analyze
sampleFiles1 <- grep("Myc_21p",list.files(directory),value=TRUE)

#Get names of samples want to analyze
NamesOfSamples <- sampleFiles1
NamesOfSamples2 <- gsub(pattern = "^\\d+_", replacement = "", x = NamesOfSamples)
NamesOfSamples3 <- gsub(pattern = "_S\\d+_L999.bam.count", replacement = "", x = NamesOfSamples2)

#Make a list of sample type
SampleType <- gsub(pattern = "_\\d$", replacement = "", x = NamesOfSamples3)

#Make a list of condition 1, ctrl or yap samples
CtrlorYap <- c(rep("Ctrl",3),rep("Yap",3))

#Make a table of sample names, file names, and condition
sampleTable <- data.frame(sampleName = NamesOfSamples3,
                          fileName = sampleFiles1,
                          phenotype = CtrlorYap,
                          sampletype = SampleType)

#Build DESeqDataSet using DESeqDataSetFromHTSeqCount function
Yap4dds <- DESeqDataSetFromHTSeqCount(sampleTable = sampleTable,
                                      directory = directory,
                                      design= ~ phenotype)

#Pre-filtering, remove rows of genes with less than 10 reads, makes things faster
keep <- rowSums(counts(Yap4dds)) >= 10
Yap4dds <- Yap4dds[keep,]

#Run deseq algorithm on dataset
Yap4dds <- DESeq(Yap4dds)

#Find genes significantly changed between Ctrl p17 and Ctrl p12
results <- results(Yap4dds,contrast=c("phenotype","Yap","Ctrl"),alpha=0.01)
resOrdered <- results[order(results$padj),]

allgenes <- row.names(resOrdered)

#basic tallies
summary(resOrdered)

#exporting results to csv files
write.csv(allgenes,
          file="gene_universe.csv",quote = FALSE,row.names=FALSE)

#exporting only results that pass adjusted p-value threshold
resSig <- subset(resOrdered, padj < 0.01)
write.csv(as.data.frame(resSig),
          file="DGEA_p0.01_Yap-Myc_vs_Ctrl-Myc_p21.csv")

GenesOfInterest <- row.names(resSig)
write.csv(GenesOfInterest, row.names = FALSE, quote = FALSE, file="ListofDiffExpGenes_Yap-Myc_vs_Ctrl-Myc_p21")

#Genes that increase
upGenes <- subset(resSig, log2FoldChange > 0)
upGeneList <- row.names(upGenes)
write.csv(as.data.frame(upGeneList),
          file="upGenes_DGEA_p0.01_Yap-Myc_vs_Ctrl-Myc.csv", row.names=FALSE, quote = FALSE)

downGenes <- subset(resSig, log2FoldChange < 0)
downGeneList <- row.names(downGenes)
write.csv(as.data.frame(downGeneList),
          file="downGenes_DGEA_p0.01_Yap-Myc_vs_Ctrl-Myc.csv", row.names=FALSE, quote = FALSE)
